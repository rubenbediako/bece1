import React, { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Button,
  Chip,
  LinearProgress,
  Alert,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Paper,
  Divider
} from '@mui/material';
import { motion } from 'framer-motion';
import { ArrowLeft, Brain, Target, TrendingUp, ChevronDown } from 'lucide-react';
import type { Subject } from '../App';

interface QuestionPredictionProps {
  subject: Subject;
  onPracticeMode: () => void;
  onBack: () => void;
}

interface PredictedQuestion {
  id: string;
  question: string;
  type: 'objective' | 'theory' | 'practical';
  topic: string;
  difficulty: 'easy' | 'medium' | 'hard';
  probability: number;
  reasoning: string;
  sampleAnswer?: string;
}

const QuestionPrediction: React.FC<QuestionPredictionProps> = ({ 
  subject, 
  onPracticeMode, 
  onBack 
}) => {
  const [predictions, setPredictions] = useState<PredictedQuestion[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedTopic, setSelectedTopic] = useState<string>('all');

  useEffect(() => {
    // Simulate AI prediction generation
    const generatePredictions = async () => {
      setLoading(true);
      
      // Simulate API call delay
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const mockPredictions = generateMockPredictions(subject);
      setPredictions(mockPredictions);
      setLoading(false);
    };

    generatePredictions();
  }, [subject]);

  const generateMockPredictions = (subject: Subject): PredictedQuestion[] => {
    const questionTemplates = getQuestionTemplates(subject.id);
    
    return questionTemplates.map((template, index) => ({
      id: `${subject.id}-${index + 1}`,
      question: template.question,
      type: template.type,
      topic: template.topic,
      difficulty: template.difficulty,
      probability: Math.random() * 0.4 + 0.6, // 60-100% probability
      reasoning: template.reasoning,
      sampleAnswer: template.sampleAnswer
    }));
  };

  const getQuestionTemplates = (subjectId: string) => {
    const templates: Record<string, any[]> = {
      mathematics: [
        {
          question: "Express 0.000456 in standard form",
          type: "theory",
          topic: "Standard Form",
          difficulty: "medium",
          reasoning: "Standard form is a fundamental topic that appears consistently in BECE mathematics, especially for very small and large numbers.",
          sampleAnswer: "0.000456 = 4.56 × 10⁻⁴"
        },
        {
          question: "Simplify: ³⁄₄ + ⁵⁄₈ - ¹⁄₂ using BODMAS",
          type: "theory",
          topic: "Fractions (BODMAS & Applications)",
          difficulty: "medium",
          reasoning: "Fraction operations with BODMAS rules are core computational skills tested in every BECE paper.",
          sampleAnswer: "³⁄₄ + ⁵⁄₈ - ¹⁄₂ = ⁶⁄₈ + ⁵⁄₈ - ⁴⁄₈ = ⁷⁄₈"
        },
        {
          question: "A trader bought goods for GH¢240 and sold them at 25% profit. Find the selling price.",
          type: "theory",
          topic: "Percentages & Applications",
          difficulty: "medium",
          reasoning: "Percentage applications in real-life contexts like profit/loss are frequently tested in BECE.",
          sampleAnswer: "Profit = 25% of 240 = 60. Selling price = 240 + 60 = GH¢300"
        },
        {
          question: "Factorize completely: 2x² + 8x + 6",
          type: "theory",
          topic: "Algebra - Factorization & Expansion",
          difficulty: "hard",
          reasoning: "Algebraic factorization is a key skill in JHS 3 curriculum and frequently appears in BECE.",
          sampleAnswer: "2x² + 8x + 6 = 2(x² + 4x + 3) = 2(x + 1)(x + 3)"
        },
        {
          question: "Expand: (2x + 3)(x - 4)",
          type: "theory",
          topic: "Two Binomials",
          difficulty: "medium",
          reasoning: "Expansion of two binomials is a standard algebraic skill tested in BECE mathematics.",
          sampleAnswer: "(2x + 3)(x - 4) = 2x² - 8x + 3x - 12 = 2x² - 5x - 12"
        },
        {
          question: "Simplify: (x² - 4)/(x + 2)",
          type: "theory",
          topic: "Algebraic Fractions",
          difficulty: "hard",
          reasoning: "Algebraic fraction simplification tests understanding of factorization and cancellation.",
          sampleAnswer: "(x² - 4)/(x + 2) = (x - 2)(x + 2)/(x + 2) = x - 2"
        },
        {
          question: "Make x the subject of the formula: y = 3x + 2z",
          type: "theory",
          topic: "Change of Subject",
          difficulty: "medium",
          reasoning: "Change of subject of formula is essential for solving real-world problems in BECE.",
          sampleAnswer: "y = 3x + 2z → y - 2z = 3x → x = (y - 2z)/3"
        },
        {
          question: "If y varies directly as x and y = 12 when x = 4, find y when x = 7",
          type: "theory",
          topic: "Variations",
          difficulty: "medium",
          reasoning: "Direct and inverse variations are practical applications frequently tested in BECE.",
          sampleAnswer: "y ∝ x, so y = kx. 12 = k(4), k = 3. When x = 7, y = 3(7) = 21"
        },
        {
          question: "Solve: 3x - 7 = 2x + 5",
          type: "theory",
          topic: "Equations & Applications",
          difficulty: "easy",
          reasoning: "Linear equation solving is fundamental and appears in every BECE mathematics paper.",
          sampleAnswer: "3x - 7 = 2x + 5 → 3x - 2x = 5 + 7 → x = 12"
        },
        {
          question: "Solve the inequality: 2x + 3 < 11",
          type: "theory",
          topic: "Inequalities & Applications",
          difficulty: "medium",
          reasoning: "Inequalities and their applications are increasingly emphasized in recent BECE papers.",
          sampleAnswer: "2x + 3 < 11 → 2x < 8 → x < 4"
        },
        {
          question: "Plot the graph of y = 2x + 1 for values of x from -2 to 3",
          type: "theory",
          topic: "Graph of Relations",
          difficulty: "medium",
          reasoning: "Graphing linear relations is essential for understanding mathematical relationships in BECE.",
          sampleAnswer: "Calculate points: (-2,-3), (-1,-1), (0,1), (1,3), (2,5), (3,7). Plot and join with straight line."
        },
        {
          question: "In triangle ABC, angle A = 60°, angle B = 80°. Find angle C.",
          type: "objective",
          topic: "Angles - Triangles & Quadrilaterals",
          difficulty: "easy",
          reasoning: "Angle properties of polygons are fundamental geometric concepts in BECE curriculum.",
          sampleAnswer: "Sum of angles in triangle = 180°. Angle C = 180° - 60° - 80° = 40°"
        },
        {
          question: "Find the area of a rectangle with length 8cm and width 5cm",
          type: "objective",
          topic: "Area & Perimeter",
          difficulty: "easy",
          reasoning: "Area and perimeter calculations are basic measurement skills tested in every BECE.",
          sampleAnswer: "Area = length × width = 8 × 5 = 40 cm²"
        },
        {
          question: "Calculate the volume of a cylinder with radius 7cm and height 10cm (π = 22/7)",
          type: "theory",
          topic: "Volume & Total Surface Area",
          difficulty: "medium",
          reasoning: "3D measurement calculations are key topics in JHS geometry curriculum.",
          sampleAnswer: "Volume = πr²h = (22/7) × 7² × 10 = (22/7) × 49 × 10 = 1540 cm³"
        },
        {
          question: "Find the mean of: 12, 15, 18, 20, 25",
          type: "objective",
          topic: "Statistics (Mean, Mode, Median)",
          difficulty: "easy",
          reasoning: "Central tendency measures are fundamental statistical concepts in BECE curriculum.",
          sampleAnswer: "Mean = (12 + 15 + 18 + 20 + 25) ÷ 5 = 90 ÷ 5 = 18"
        },
        {
          question: "From a cumulative frequency curve, find the first quartile if the total frequency is 40",
          type: "theory",
          topic: "Cumulative Frequency (Quartiles, Percentiles, Deciles)",
          difficulty: "hard",
          reasoning: "Quartiles from cumulative frequency curves are advanced statistical skills in JHS 3.",
          sampleAnswer: "Q₁ position = ¼ × 40 = 10th value. Read corresponding value from cumulative frequency curve."
        },
        {
          question: "What is the probability of getting a head when a fair coin is tossed?",
          type: "objective",
          topic: "Probability",
          difficulty: "easy",
          reasoning: "Basic probability concepts are fundamental and appear in every BECE mathematics paper.",
          sampleAnswer: "P(Head) = Number of favorable outcomes / Total outcomes = 1/2"
        },
        {
          question: "Construct a triangle ABC where AB = 6cm, BC = 8cm, and AC = 7cm",
          type: "practical",
          topic: "Construction",
          difficulty: "medium",
          reasoning: "Geometric constructions are practical skills emphasized in BECE mathematics.",
          sampleAnswer: "Use compass and ruler: Draw AB = 6cm, arc from A with radius 7cm, arc from B with radius 8cm, mark intersection as C."
        },
        {
          question: "If vector a = (3, 4) and vector b = (1, 2), find a + b",
          type: "theory",
          topic: "Vectors",
          difficulty: "medium",
          reasoning: "Vector operations are introduced in JHS 3 and increasingly appear in recent BECE papers.",
          sampleAnswer: "a + b = (3, 4) + (1, 2) = (3+1, 4+2) = (4, 6)"
        },
        {
          question: "Find the distance between points A(2, 3) and B(5, 7)",
          type: "theory",
          topic: "Coordinate Geometry",
          difficulty: "medium",
          reasoning: "Coordinate geometry applications are essential for connecting algebra and geometry in BECE.",
          sampleAnswer: "Distance = √[(5-2)² + (7-3)²] = √[9 + 16] = √25 = 5 units"
        },
        {
          question: "In a right-angled triangle, if the opposite side is 3cm and hypotenuse is 5cm, find sin θ",
          type: "theory",
          topic: "Trigonometry",
          difficulty: "medium",
          reasoning: "Basic trigonometric ratios are essential for solving practical problems in BECE.",
          sampleAnswer: "sin θ = opposite/hypotenuse = 3/5 = 0.6"
        },
        {
          question: "Describe the transformation that maps triangle A to triangle B if B is a reflection of A in the y-axis",
          type: "theory",
          topic: "Transformations",
          difficulty: "medium",
          reasoning: "Geometric transformations help students understand spatial relationships in BECE curriculum.",
          sampleAnswer: "Reflection in the y-axis: (x, y) → (-x, y). Each point's x-coordinate changes sign, y-coordinate remains same."
        }
      ],
      english: [
        {
          question: "Write a letter to your friend describing your school's cultural festival",
          type: "theory",
          topic: "Letter Writing",
          difficulty: "medium",
          reasoning: "Informal letter writing about cultural events is a recurring theme in BECE English papers.",
          sampleAnswer: "Include: proper letter format, vivid descriptions of events, personal experiences, and appropriate informal tone."
        },
        {
          question: "Identify the figure of speech in: 'The classroom was a zoo during break time'",
          type: "objective",
          topic: "Grammar",
          difficulty: "easy",
          reasoning: "Figures of speech identification is a standard component of BECE English language papers.",
          sampleAnswer: "Metaphor - comparing the classroom to a zoo without using 'like' or 'as'"
        }
      ],
      science: [
        {
          question: "Explain the process of photosynthesis and write its chemical equation",
          type: "theory",
          topic: "Biology",
          difficulty: "medium",
          reasoning: "Photosynthesis is a fundamental biological process frequently tested in BECE science.",
          sampleAnswer: "6CO₂ + 6H₂O + light energy → C₆H₁₂O₆ + 6O₂. Process occurs in chloroplasts using chlorophyll."
        },
        {
          question: "State three properties of acids",
          type: "objective",
          topic: "Chemistry",
          difficulty: "easy",
          reasoning: "Basic properties of acids and bases are consistently tested concepts in BECE integrated science.",
          sampleAnswer: "1. Turn blue litmus paper red, 2. Have sour taste, 3. React with metals to produce hydrogen gas"
        }
      ]
    };

    return templates[subjectId] || [];
  };

  const getDifficultyColor = (difficulty: string) => {
    switch (difficulty) {
      case 'easy': return 'success';
      case 'medium': return 'warning';
      case 'hard': return 'error';
      default: return 'primary';
    }
  };

  const filteredPredictions = selectedTopic === 'all' 
    ? predictions 
    : predictions.filter(p => p.topic === selectedTopic);

  if (loading) {
    return (
      <Box sx={{ textAlign: 'center', py: 4 }}>
        <motion.div
          initial={{ scale: 0.8, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          transition={{ duration: 0.5 }}
        >
          <Brain size={64} color="#2196F3" />
          <Typography variant="h5" sx={{ mt: 2, mb: 1 }}>
            AI is analyzing {subject.name} patterns...
          </Typography>
          <Typography variant="body1" color="text.secondary" sx={{ mb: 3 }}>
            Processing past BECE papers to predict 2026 questions
          </Typography>
          <LinearProgress sx={{ width: '300px', mx: 'auto' }} />
        </motion.div>
      </Box>
    );
  }

  return (
    <Box>
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
        <Button 
          startIcon={<ArrowLeft />} 
          onClick={onBack}
          sx={{ mr: 2 }}
        >
          Back to Subjects
        </Button>
        <Typography variant="h4" sx={{ flexGrow: 1 }}>
          {subject.name} Predictions
        </Typography>
        <Button 
          variant="contained" 
          color="secondary"
          onClick={onPracticeMode}
          sx={{ ml: 2 }}
        >
          Start Practice
        </Button>
      </Box>

      <Alert severity="info" sx={{ mb: 3 }}>
        <strong>AI Analysis Complete:</strong> Generated {predictions.length} predicted questions 
        based on BECE patterns from 2015-2025. Accuracy rate: 87%
      </Alert>

      <Box sx={{ display: 'flex', gap: 3, mb: 3, flexDirection: { xs: 'column', md: 'row' } }}>
        <Paper sx={{ p: 2, flex: 2 }}>
          <Typography variant="h6" gutterBottom>Filter by Topic</Typography>
          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
            <Chip 
              label="All Topics" 
              color={selectedTopic === 'all' ? 'primary' : 'default'}
              onClick={() => setSelectedTopic('all')}
              clickable
            />
            {subject.topics.map(topic => (
              <Chip 
                key={topic}
                label={topic} 
                color={selectedTopic === topic ? 'primary' : 'default'}
                onClick={() => setSelectedTopic(topic)}
                clickable
              />
            ))}
          </Box>
        </Paper>
        <Paper sx={{ p: 2, flex: 1, textAlign: 'center' }}>
          <Target size={32} color="#FF9800" />
          <Typography variant="h6" color="primary">
            Prediction Accuracy
          </Typography>
          <Typography variant="h4" color="secondary">
            87%
          </Typography>
          <Typography variant="body2" color="text.secondary">
            Based on 2015-2025 BECE analysis
          </Typography>
        </Paper>
      </Box>

      <Typography variant="h5" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
        <TrendingUp /> Predicted Questions ({filteredPredictions.length})
      </Typography>

      {filteredPredictions.map((prediction, index) => (
        <motion.div
          key={prediction.id}
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ duration: 0.3, delay: index * 0.1 }}
        >
          <Accordion sx={{ mb: 2 }}>
            <AccordionSummary expandIcon={<ChevronDown />}>
              <Box sx={{ width: '100%', display: 'flex', alignItems: 'center', gap: 2 }}>
                <Typography variant="h6" sx={{ flexGrow: 1 }}>
                  Question {index + 1}
                </Typography>
                <Chip label={prediction.topic} size="small" />
                <Chip 
                  label={prediction.difficulty} 
                  size="small" 
                  color={getDifficultyColor(prediction.difficulty)} 
                />
                <Chip 
                  label={`${Math.round(prediction.probability * 100)}% probability`}
                  size="small"
                  color="primary"
                  variant="outlined"
                />
              </Box>
            </AccordionSummary>
            <AccordionDetails>
              <Box>
                <Typography variant="h6" gutterBottom color="primary">
                  Question:
                </Typography>
                <Typography variant="body1" paragraph sx={{ 
                  fontWeight: 'medium', 
                  p: 2, 
                  bgcolor: 'grey.50', 
                  borderRadius: 1 
                }}>
                  {prediction.question}
                </Typography>

                <Typography variant="h6" gutterBottom color="primary">
                  AI Reasoning:
                </Typography>
                <Typography variant="body2" paragraph color="text.secondary">
                  {prediction.reasoning}
                </Typography>

                {prediction.sampleAnswer && (
                  <>
                    <Divider sx={{ my: 2 }} />
                    <Typography variant="h6" gutterBottom color="secondary">
                      Sample Answer/Approach:
                    </Typography>
                    <Typography variant="body2" sx={{ 
                      p: 2, 
                      bgcolor: 'secondary.light', 
                      color: 'secondary.contrastText',
                      borderRadius: 1 
                    }}>
                      {prediction.sampleAnswer}
                    </Typography>
                  </>
                )}
              </Box>
            </AccordionDetails>
          </Accordion>
        </motion.div>
      ))}

      {filteredPredictions.length === 0 && (
        <Alert severity="warning">
          No predictions found for the selected topic. Try selecting "All Topics" or a different topic.
        </Alert>
      )}
    </Box>
  );
};

export default QuestionPrediction;
